<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>AR Pump Digital Twin</title>

<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDGW9FxKJ5sUhXw_lW4p2ncZw2qUhI5NvA",
  authDomain: "motor-digital-twin.firebaseapp.com",
  databaseURL: "https://motor-digital-twin-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "motor-digital-twin",
  storageBucket: "motor-digital-twin.firebasestorage.app",
  messagingSenderId: "100929182719",
  appId: "1:100929182719:web:b7aeb33742e4d169f0a5ca"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const liveRef = ref(database, "raw/live");

let temperature = 0;
let vibration = 0;
let runtime = 0;

onValue(liveRef, (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    temperature = parseFloat(data.temperature ?? 0);
    vibration = parseFloat(data.vibration ?? 0);
    runtime = parseFloat(data.runtime_seconds ?? 0);

    document.getElementById("temp").innerText = temperature.toFixed(1);
    document.getElementById("vib").innerText = vibration.toFixed(2);
    document.getElementById("runtime").innerText = runtime;

    updateStatus();
    updateModelColor();
});

function updateStatus() {
    const status = document.getElementById("status");

    if (temperature > 85 || vibration > 1.8 || runtime > 5000) {
        status.innerText = "CRITICAL";
        status.style.background = "#ef4444";
    }
    else if (temperature > 65 || vibration > 1.0 || runtime > 3000) {
        status.innerText = "WARNING";
        status.style.background = "#eab308";
    }
    else {
        status.innerText = "NORMAL";
        status.style.background = "#22c55e";
    }
}

function updateModelColor() {
    const model = document.querySelector("#pumpModel");
    if (!model) return;

    let healthFactor = Math.min(1, Math.max(0, (temperature - 35) / 60));
    let r = Math.floor(255 * healthFactor);
    let g = Math.floor(255 * (1 - healthFactor));
    let color = `rgb(${r},${g},0)`;

    model.setAttribute("material", "color", color);
}
</script>

<style>
body {
  margin:0;
  overflow:hidden;
  font-family:Arial;
}

/* ===== Mobile Top Dashboard ===== */
#dashboard {
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  width:90%;
  max-width:360px;
  background:rgba(0,0,0,0.85);
  padding:10px;
  border-radius:12px;
  color:white;
  z-index:10;
  font-size:13px;
  box-shadow:0 4px 10px rgba(0,0,0,0.4);
}

#dashboard h3 {
  margin:0 0 6px 0;
  font-size:15px;
  text-align:center;
}

/* Data rows */
.data-row {
  display:flex;
  justify-content:space-between;
  margin:3px 0;
}

.status {
  padding:6px;
  margin-top:6px;
  text-align:center;
  font-weight:bold;
  border-radius:6px;
}

/* Smaller screens */
@media (max-width:480px){
  #dashboard {
    font-size:12px;
    padding:8px;
  }
}
</style>

<script>
// ===== PLAY ANIMATIONS =====
AFRAME.registerComponent('play-all-animations', {
  init: function () {
    this.el.addEventListener('model-loaded', () => {
      const mesh = this.el.getObject3D('mesh');
      if (!mesh.animations || mesh.animations.length === 0) return;

      const mixer = new THREE.AnimationMixer(mesh);
      mesh.animations.forEach((clip) => mixer.clipAction(clip).play());
      this.mixer = mixer;
    });
  },
  tick: function (t, dt) {
    if (this.mixer) this.mixer.update(dt / 1000);
  }
});

// ===== TOUCH ROTATE =====
AFRAME.registerComponent('drag-rotate', {
  init: function () {
    this.isDragging = false;
    this.lastX = 0;

    const scene = this.el.sceneEl;

    scene.addEventListener('touchstart', e => {
      this.isDragging = true;
      this.lastX = e.touches[0].clientX;
    });

    scene.addEventListener('touchend', () => this.isDragging = false);

    scene.addEventListener('touchmove', e => {
      if (!this.isDragging) return;
      const dx = (e.touches[0].clientX - this.lastX) * 0.01;
      this.el.object3D.rotation.y += dx;
      this.lastX = e.touches[0].clientX;
    });
  }
});
</script>

</head>

<body>

<!-- ===== Dashboard ===== -->
<div id="dashboard">
  <h3>Pump Motor</h3>

  <div class="data-row">
    <span>Temp:</span>
    <b><span id="temp">--</span> Â°C</b>
  </div>

  <div class="data-row">
    <span>Vibration:</span>
    <b><span id="vib">--</span> g</b>
  </div>

  <div class="data-row">
    <span>Runtime:</span>
    <b><span id="runtime">--</span> sec</b>
  </div>

  <div id="status" class="status">NORMAL</div>
</div>

<!-- ===== AR Scene ===== -->
<a-scene
  embedded
  vr-mode-ui="enabled:false"
  renderer="antialias:true; alpha:true"
  arjs="sourceType:webcam; debugUIEnabled:false;">

  <a-entity
    id="pumpModel"
    gltf-model="water_pump.glb"
    animation-mixer
    play-all-animations
    position="0 0 -1"
    rotation="0 0 0"
    scale="1 1 1"
    drag-rotate
    model-zoom>
  </a-entity>

  <a-entity camera></a-entity>

</a-scene>

</body>
</html>
